version: '1.0'
steps: 
    build-step:
        description: Building the image.
        title: Build the Docker image...
        type: build
        dockerfile: Dockerfile
        image-name: aloncodefresh/demochat
        tag: codefresh
    freestyle-step:
        description: Freestyle step..
        title: Free styling
        image: nhoag/curl
        commands:
          - echo "step 1"
          - ls /codefresh/volume
          - echo ---------------------------- START
          - echo /codefresh/volume/cf_export IS
          - cat /codefresh/volume/cf_export
          - echo ---------------------------- END          
          - echo ---------------------------- START
          - echo /codefresh/volume/env_vars_to_export IS
          - cat /codefresh/volume/env_vars_to_export
          - echo ---------------------------- END
          - export EXPORTED=EXPVAL
          - echo Exported is $EXPORTED
          - echo CF_BRANCH is $CF_BRANCH 
          - /codefresh/volume/cf_export SOME=VALUE1 EXPORTED CF_BRANCH
          - echo ---------------------------- START
          - echo /codefresh/volume/env_vars_to_export IS AFTER
          - cat /codefresh/volume/env_vars_to_export
          - echo ---------------------------- END
    freestyle-step2:
        description: Freestyle step 2..
        title: Free styling 2
        image: nhoag/curl
        commands:
          - echo "Step 2"
          - ls /codefresh/volume
          - echo ---------------------------- START
          - echo /codefresh/volume/env_vars_to_export IS
          - cat /codefresh/volume/env_vars_to_export
          - echo ---------------------------- END
          - echo ANOTHER=VALUE2 >> /codefresh/volume/env_vars_to_export
          - echo ---------------------------- START
          - echo /codefresh/volume/env_vars_to_export IS AFTER
          - cat /codefresh/volume/env_vars_to_export
          - echo ---------------------------- END          
    freestyle-step3:
        description: Freestyle step 3..
        title: Free styling 3
        image: nhoag/curl
        commands:
          - echo "Step 3"
          - ls /codefresh/volume
          - echo ---------------------------- START
          - echo /codefresh/volume/env_vars_to_export IS
          - cat /codefresh/volume/env_vars_to_export
          - echo ---------------------------- END
          - cf_export LAST=VALUE3
          - echo ---------------------------- START
          - echo /codefresh/volume/env_vars_to_export IS AFTER
          - cat /codefresh/volume/env_vars_to_export
          - echo ---------------------------- END                    
    composition-step:
      title: Running as a composition...
      description: Attempting to run as part of composition.
      type: composition
      composition: 
        version: '2'
        services:
          app:
            image: nhoag/curl
            environment:
              - echo ANOTHER is ${{ANOTHER}} and also ${ANOTHER} and also $ANOTHER
          app2:
            image: nhoag/curl
            environment:
              - echo SOME is ${{SOME}}              
      composition-candidates:
        main:
          image: nhoag/curl
          command: bash -c "sleep 20" | echo 'works'
