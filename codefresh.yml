version: '1.0'
steps:
    build-step:
        description: Building the image.
        title: Build the Docker image...
        type: build
        dockerfile: Dockerfile
        image-name: aloncodefresh/demochat
        tag: codefresh
    freestyle-step:
        description: Freestyle step..
        title: Free styling
        image: nhoag/curl
        commands:
          - echo "step 1"
          - ls /codefresh/volume
          - echo ---------------------------- START
          - echo /codefresh/volume/env_vars_to_export IS
          - cat /codefresh/volume/env_vars_to_export
          - echo ---------------------------- END
          - /codefresh/volume/cf_export SOME=VALUE
          - echo ---------------------------- START
          - echo /codefresh/volume/env_vars_to_export IS AFTER
          - cat /codefresh/volume/env_vars_to_export
          - echo ---------------------------- END
    freestyle-step2:
        description: Freestyle step 2..
        title: Free styling
        image: nhoag/curl
        commands:
          - echo "Step 2"
          - ls /codefresh/volume
          - echo ---------------------------- START
          - echo /codefresh/volume/env_vars_to_export IS
          - cat /codefresh/volume/env_vars_to_export
          - echo ---------------------------- END
          - /codefresh/volume/cf_export ANOTHER="VALUE OH YES"
          - echo ---------------------------- START
          - echo /codefresh/volume/env_vars_to_export IS AFTER
          - cat /codefresh/volume/env_vars_to_export
          - echo ---------------------------- END          
    composition-step:
      title: Running as a composition...
      description: Attempting to run as part of composition.
      type: composition
      composition: 
        version: '2'
        services:
          app:
            image: 'aloncodefresh/demochat:master'
            ports:
              - 5000
            depends_on:
              - mongo
          mongo:
            image: mongo
      composition-candidates:
        main:
          image: nhoag/curl
          command: bash -c "sleep 20 && curl http://app:5000/" | echo 'works'
    push-step:
        description: Pushing image to Docker hub.
        type: push
        candidate: ${{build-step}}
        tag: ${{CF_BRANCH}}        
