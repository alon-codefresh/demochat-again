version: '1.0'
steps:

  build-step:
    description: Building the image.
    type: build
    dockerfile: Dockerfile
    image-name: advance512demo/demochat
    tag: codefresh
  
  another-step:
    description: Another step.
    image: ${{build-step}}
    commands:
      - echo $(date)
    when:
      condition:
        all:
          commitMessageNotContainSkip: "includes(Variable('initial-clone').commitMessage, '[skip ci]') == false"
          commitMessageNotContainSkip2: "includes(Variable('initial-clone').commitMessage, '[ci skip]') == false"
          branchIsConditionalStep: "Variable('initial-clone').branch == 'conditional_step'"
          branchIsConditionalStep2: "'${{CF_BRANCH}}' == 'conditional_step'"
          badSyntax: "2 * 3 <> 55"
          commitMessageIsHi: "'${{CF_COMMIT_MESSAGE}}' == 'hi'"
    
  yet-another-freestyle-step:
    description: Yet another freestyle step
    image: ${{build-step}}
    commands:
      - echo $(date)
    when:
      condition:
        any:
          branchIsTestMe: "'${{CF_BRANCH}}' == 'test_me'"
          branchIsTestHim: "'${{CF_BRANCH}}' == 'test_him'"
          branchIsTestHer: "'${{CF_BRANCH}}' == 'test_her'"
          branchIsTestMe2: "Variable('initial-clone').branch == 'test_me'"
          branchIsTestHim2: "Variable('initial-clone').branch == 'test_him'"
          branchIsTestHer2: "Variable('initial-clone').branch == 'test_her'"
          twoByThree: "2 * 3 == 6"
       
  incredibly-another-freestyle-step:
    description: Incredibly another freestyle step
    image: ${{build-step}}
    commands:
      - echo $(date)
    when:
      condition:

    build-step:
        description: Building the image.
        title: Build the Docker image...
        type: build
        dockerfile: Dockerfile
        image-name: advance512demo/demochat
        tag: codefresh
    unit-test-via-gulp:
      description: Running unit test via gulp.
      title: Run the Gulp unit test...
      image: monostream/nodejs-gulp-bower:latest
      fail-fast: false
      working-directory : ${{initial-clone}}
      commands:
        - npm install
        - gulp test
        - echo $(date)
    unit-test-via-npm:
      description: Running unit test via npm.
      image: ${{build-step}}
      fail-fast: false
      commands:
        - npm test
        - echo $(date)
    composition-step:
      title: Running as a composition...
      description: Attempting to run as part of composition.
      type: composition
      composition: 
        version: '2'
        services:
          app:
            image: 'advance512demo/demochat:master'
            ports:
              - 5000
            depends_on:
              - mongo
          mongo:
            image: mongo
      composition-candidates:
        main:
          image: nhoag/curl
          command: bash -c "sleep 20 && curl http://app:5000/" | echo 'works'

    push-step:
        description: Pushing image to Docker hub.
        type: push
        candidate: ${{build-step}}
        tag: ${{CF_BRANCH}}        
